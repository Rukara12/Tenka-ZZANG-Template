<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>텐카 템플릿</title>
    <style>
        #meme-container {
            position: relative;
            width: 1024px;
            height: 765px;
            margin: 20px auto;
            border: 2px solid #333;
            overflow: hidden;
            background-color: #f0f0f0;
            user-select: none;
        }

        .photo-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden;
        }

        .preview-image {
            position: absolute;
            top: 150px; left: 300px;
            width: 400px; height: auto;
            display: none; cursor: move;
            transform-origin: center;
        }

        #layer-photo-1 { z-index: 1; }
        #layer-photo-2 { z-index: 2; }

        #background-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('tenka.png'); 
            background-size: 100% 100%;
            z-index: 3;
            pointer-events: none;
        }

        .bubble {
            position: absolute;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-family: '맑은 고딕', sans-serif; /* 기본 폰트 */
            font-weight: bold;
            line-height: 1.2;
            z-index: 4;
            outline: none;
            white-space: pre-wrap;
            word-break: break-word;
            padding: 15px;
            box-sizing: border-box;
            overflow: hidden;
        }

        #bubble-top-left { top: 1px; left: 1px; width: 205px; height: 330px; }
        #bubble-bottom-left { top: 420px; left: 1px; width: 230px; height: 350px; }
        #bubble-top-right { top: 1px; left: 810px; width: 215px; height: 410px; }

        #controls { text-align: center; padding: 20px; background: #eee; border-bottom: 1px solid #ccc; font-family: sans-serif; }
        .btn-group { margin-bottom: 10px; }
        button { padding: 10px 20px; font-size: 15px; cursor: pointer; border-radius: 4px; border: 1px solid #999; font-weight: bold; }
        .save-btn { background: #28a745; color: white; border: none; }
        .upload-btn { background: #007bff; color: white; border: none; margin: 0 5px; }
        .font-btn { background: #6c757d; color: white; border: none; margin: 0 5px; } /* 폰트 버튼 스타일 추가 */
        .selector { margin: 10px; font-weight: bold; font-size: 16px; padding: 10px; background: #fff; display: inline-block; border-radius: 8px; border: 1px solid #ddd; }
        .hint { color: #666; font-size: 13px; margin-top: 5px; }
    </style>
</head>
<body>

<div id="controls">
    <div class="btn-group">
        <button class="upload-btn" onclick="document.getElementById('img-input-1').click();">사진 1 업로드(뒤)</button>
        <button class="upload-btn" onclick="document.getElementById('img-input-2').click();">사진 2 업로드(앞)</button>
        <button class="font-btn" onclick="document.getElementById('font-input').click();">폰트 업로드 (.ttf, .otf)</button>
        <button class="save-btn" id="save-btn">이미지 저장하기</button>
    </div>

    <div class="selector">
        조작 대상: 
        <label style="cursor:pointer"><input type="radio" name="target" value="1" checked> 사진 1 (뒤)</label>
        &nbsp;
        <label style="cursor:pointer"><input type="radio" name="target" value="2"> 사진 2 (앞)</label>
    </div>
    
    <div class="hint">대상 선택 후 드래그로 이동, 휠로 크기를 조절하세요. 글자가 길어지면 자동으로 크기가 줄어듭니다.</div>

    <input type="file" id="img-input-1" accept="image/*" style="display:none">
    <input type="file" id="img-input-2" accept="image/*" style="display:none">
    <input type="file" id="font-input" accept=".ttf, .otf" style="display:none">
</div>

<div id="meme-container">
    <div id="layer-photo-1" class="photo-layer"><img id="img-1" class="preview-image" draggable="false"></div>
    <div id="layer-photo-2" class="photo-layer"><img id="img-2" class="preview-image" draggable="false"></div>
    <div id="background-layer"></div>

    <div id="bubble-top-left" class="bubble" contenteditable="true" spellcheck="false">텍스트 입력</div>
    <div id="bubble-bottom-left" class="bubble" contenteditable="true" spellcheck="false">텍스트 입력</div>
    <div id="bubble-top-right" class="bubble" contenteditable="true" spellcheck="false">텍스트 입력</div>
</div>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
    // --- [1] 글자 크기 자동 조절 로직 ---
    const maxFontSize = 32;
    const minFontSize = 12;

    function adjustFontSize(el) {
        let fontSize = maxFontSize;
        el.style.fontSize = fontSize + 'px';
        while ((el.scrollHeight > el.offsetHeight || el.scrollWidth > el.offsetWidth) && fontSize > minFontSize) {
            fontSize--;
            el.style.fontSize = fontSize + 'px';
        }
    }

    document.querySelectorAll('.bubble').forEach(bubble => {
        adjustFontSize(bubble);
        bubble.addEventListener('input', () => adjustFontSize(bubble));
        bubble.addEventListener('paste', (e) => {
            e.preventDefault();
            const text = e.clipboardData.getData('text/plain');
            document.execCommand('insertText', false, text);
            adjustFontSize(bubble);
        });
    });

    // --- [폰트 로드 로직 추가] ---
    document.getElementById('font-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const fontName = 'UploadedCustomFont';
                // FontFace API를 사용하여 업로드된 파일을 폰트로 등록
                const fontFace = new FontFace(fontName, ev.target.result);
                
                try {
                    const loadedFace = await fontFace.load();
                    document.fonts.add(loadedFace);
                    
                    // 모든 말풍선에 새 폰트 적용
                    document.querySelectorAll('.bubble').forEach(bubble => {
                        bubble.style.fontFamily = fontName;
                        adjustFontSize(bubble); // 폰트 변경에 따른 크기 재조정
                    });
                    alert('폰트가 성공적으로 적용되었습니다.');
                } catch (err) {
                    console.error(err);
                    alert('폰트 파일을 로드하는 데 실패했습니다.');
                }
            };
            reader.readAsArrayBuffer(file);
        }
    });

    // --- [2] 사진 조작 로직 ---
    const states = {
        1: { x: 0, y: 0, scale: 1.0, el: document.getElementById('img-1') },
        2: { x: 0, y: 0, scale: 1.0, el: document.getElementById('img-2') }
    };

    let isDragging = false, startX, startY;

    function getTargetId() {
        return document.querySelector('input[name="target"]:checked').value;
    }

    function updateTransform(id) {
        const s = states[id];
        if (s.el) {
            s.el.style.transform = `translate(${s.x}px, ${s.y}px) scale(${s.scale})`;
        }
    }

    function setupUpload(id) {
        document.getElementById(`img-input-${id}`).addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    states[id].el.src = ev.target.result;
                    states[id].el.style.display = 'block';
                    updateTransform(id);
                };
                reader.readAsDataURL(file);
            }
        });
    }
    setupUpload(1); setupUpload(2);

    const container = document.getElementById('meme-container');

    container.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('bubble')) return;
        const id = getTargetId();
        if (!states[id].el.src) return;

        isDragging = true;
        startX = e.clientX - states[id].x;
        startY = e.clientY - states[id].y;
    });

    window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const id = getTargetId();
        states[id].x = e.clientX - startX;
        states[id].y = e.clientY - startY;
        updateTransform(id);
    });

    window.addEventListener('mouseup', () => isDragging = false);

    container.addEventListener('wheel', (e) => {
        const id = getTargetId();
        if (!states[id].el.src) return;
        e.preventDefault();

        const zoomSpeed = 0.05;
        if (e.deltaY < 0) states[id].scale += zoomSpeed;
        else states[id].scale = Math.max(0.1, states[id].scale - zoomSpeed);
        updateTransform(id);
    }, { passive: false });

    // --- [3] 저장 로직 ---
    document.getElementById('save-btn').addEventListener('click', function() {
        html2canvas(container, { scale: 2, useCORS: true }).then(canvas => {
            const link = document.createElement('a');
            link.download = '텐카 바이럴.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    });
</script>

</body>
</html>
